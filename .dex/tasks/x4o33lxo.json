{
  "id": "x4o33lxo",
  "parent_id": "cs7gqxmn",
  "description": "Phase 7: Expand Test Coverage",
  "context": "Phase 7: Expand test coverage across all packages and apps. After Phase 6 validation, this phase focuses on adding comprehensive tests to improve coverage and catch regressions.\n\nExisting tests from Phase 4:\n- apps/worker/src/queue.test.ts (5 tests passing)\n- apps/controller/src/registry/worker-registry.test.ts\n- apps/controller/test/spawn-worker.test.ts\n- apps/worker/test/player-lifecycle.test.ts\n- packages/testkit/src/index.test.ts (5 tests passing)\n\nNew test coverage tasks:\n\n1. Queue tests (ej08voad):\n- Test queue limit/size constraints\n- Test duplicate song handling\n- Test song metadata (url, requesterId)\n- Test queue ordering FIFO behavior\n- Test queue.playing state management\n- Test edge cases (empty queue, full queue)\n\n2. Player state management tests (g9nh6cfq):\n- Test player volume controls\n- Test play/pause/resume state transitions\n- Test song skipping with queue management\n- Test getPlayerStatus() method\n- Test getRawPlayer() integration\n- Test error handling in downloadAndPlayYouTubeAudio\n- Test mock dependency injection scenarios\n\n3. WorkerRegistry health check tests (kee0v50g):\n- Test health check interval management\n- Test health check timeout handling\n- Test health status propagation to worker metadata\n- Test loadExistingWorkers() edge cases (empty, malformed labels)\n- Test getWorker() and getAllWorkers()\n- Test unregisterWorker() cleanup\n- Test concurrent worker registration\n\n4. K8s API adapter tests (5a6ovm0f):\n- Test lazy initialization of getCoreV1Api()\n- Test setCoreV1Api() injection\n- Test resetCoreV1Api() isolation\n- Test getAppsV1Api() parallel clients\n- Test createNamespacedPod() error handling\n- Test listNamespacedService() with filters\n- Test delete operations with cleanup verification\n- Test adapter state between test cases\n\n5. gRPC client tests (cnuvyupf):\n- Test addSong() with validation\n- Test skipSong() with queue state\n- Test pauseSong() and resumeSong() state checks\n- Test queueSong() with queue limits\n- Test clearQueue() cleanup behavior\n- Test error responses from gRPC calls\n- Test mock client reset between tests\n\n6. Discord bot command tests (8akwsh11):\n- Test join command (worker spawning)\n- Test play command with URL validation\n- Test skip, pause, resume commands\n- Test queue command display\n- Test leave command (worker cleanup)\n- Test command error handling and user feedback\n- Test Discord API mock integration\n\n7. Environment configuration tests (vj5j934h):\n- Test required environment variables presence\n- Test environment variable parsing\n- Test default value handling\n- Test invalid value validation\n- Test Zod schema validation for env config\n- Test environment-specific configurations (dev/prod)\n- Test type safety of env object\n\n8. Sentry error capture tests (70onhsxo):\n- Test captureException() with context tags\n- Test error object formatting\n- Test breadcrumb creation\n- Test Sentry client initialization\n- Test network error handling\n- Test error propagation through gRPC\n- Test Sentry mock verification\n\n9. Worker lifecycle integration tests (bcv336e6):\n- Test worker initialization with dependencies\n- Test worker startup sequence\n- Test worker shutdown flow (graceful and forced)\n- Test worker health registration\n- Test worker reconnection handling\n- Test worker error recovery\n- Test inactivity timeout behavior\n- Test process.exit() wrapping in tests\n\n10. Discord interaction registry tests (jjx95gn8):\n- Test registerInteraction() adds to registry\n- Test getInteractions() returns all registered\n- Test getInteraction() finds by name\n- Test getInteraction() returns undefined for missing\n- Test executeCommandHandler() with valid command\n- Test executeCommandHandler() with non-chat input (ignores)\n- Test executeCommandHandler() with missing command (rejects)\n- Test executeCommandHandler() with execution error (catches and rejects)\n- Test interaction registry isolation between tests\n\n11. K8s resource generation tests (denmmuw1):\n- Test createWorkerResources() generates valid pod spec\n- Test createWorkerResources() generates valid service spec\n- Test pod labels include guild and channel IDs\n- Test service has correct selector for pod\n- Test service port configuration\n- Test resource limits/requests if configured\n- Test owner references for cleanup\n- Test pod image and command configuration\n\n12. gRPC server handler tests (4g1v2cw9):\n- Test health check handler returns healthy status\n- Test player handler for addSong()\n- Test player handler for skipSong()\n- Test player handler for pauseSong()\n- Test player handler for resumeSong()\n- Test player handler for queueSong()\n- Test player handler for clearQueue()\n- Test search handler with valid query\n- Test search handler with empty query\n- Test worker lifecycle handler (notifyShutdown)\n- Test error handling in gRPC calls\n- Test handler mock validation\n\n13. Discord command individual tests (bitfyffw):\n- Test clear.ts command (worker check, gRPC call, reply)\n- Test pause.ts command (worker check, gRPC call, reply)\n- Test skip.ts command (worker check, gRPC call, reply)\n- Test resume.ts command (worker check, gRPC call, reply)\n- Test queue.ts command (worker check, gRPC call, reply)\n- Test summary.ts command with worker status\n- Test all commands handle missing guildId\n- Test all commands handle missing worker\n- Test all commands handle gRPC errors\n- Test command registration via registerInteraction\n\n14. HTTP API route tests (urzea3qy):\n- Test health check endpoint returns 200\n- Test worker status endpoint\n- Test worker listing endpoint\n- Test worker creation endpoint (POST)\n- Test worker deletion endpoint (DELETE)\n- Test middleware error handling\n- Test request validation\n- Test response JSON structure\n- Test 404 for unknown routes\n- Test CORS headers if configured\n\n15. Discord voice connection tests (8whq6kvu):\n- Test getVoiceConnection() returns connection\n- Test getVoiceConnection() returns undefined if none\n- Test voice connection state management\n- Test voice channel joining\n- Test voice channel leaving\n- Test voice connection error handling\n- Test audio player attachment\n- Test voice connection mock isolation\n\n16. YouTube URL validation tests (xa6zr3yx):\n- Test valid YouTube URL patterns (youtube.com, youtu.be)\n- Test YouTube playlist URL detection\n- Test YouTube short URL handling\n- Test invalid URL rejection\n- Test URL parameter extraction (video ID)\n- Test URL sanitization\n- Test empty URL handling\n- Test malformed URL error messages\n- Test multiple URL format variations\n\n17. Inactivity timeout tests (i9axdqy6):\n- Test inactivity detection after timeout\n- Test inactivity timeout doesn't trigger during playback\n- Test inactivity timeout resets on activity\n- Test graceful shutdown sequence\n- Test voice connection cleanup on timeout\n- Test gRPC shutdown notification on timeout\n- Test process.exit() called with correct code\n- Test timeout configuration from environment\n- Test fake timers for timeout testing\n- Test cleanup before process exit\n\nThis phase ensures all critical paths have comprehensive test coverage beyond initial examples from Phase 4.",
  "priority": 1,
  "completed": false,
  "result": null,
  "metadata": null,
  "created_at": "2026-01-27T22:05:22.279Z",
  "updated_at": "2026-01-27T22:17:34.836Z",
  "completed_at": null,
  "blockedBy": [],
  "blocks": [],
  "children": [
    "kee0v50g",
    "bcv336e6",
    "g9nh6cfq",
    "jjx95gn8",
    "4g1v2cw9",
    "i9axdqy6",
    "qv82yj77",
    "r55uiwdd",
    "oxxwg8pb",
    "gwtkier9",
    "nnpxd2mr",
    "rmcg9ycs",
    "61j2vu33",
    "nkb25f0a",
    "fa3dd4r2",
    "pzbyeiop"
  ]
}